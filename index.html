<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Basma Games</title>
<style>
:root{--bg:#eaf2ff;--card:#ffffff;--accent:#1e6fff;--muted:#6b7280;--success:#16a34a;}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#0f172a}
.container{max-width:1100px;margin:18px auto;padding:16px}
.header{display:flex;align-items:center;gap:12px;justify-content:space-between}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#49a1ff);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px;box-shadow:0 6px 18px rgba(30,111,255,.18)}
.title{font-size:20px;font-weight:700}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
.btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(30,111,255,.15)}
.card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(15,23,42,.04);margin-top:12px}
.flex{display:flex;gap:12px}
.col{flex:1}
.small{font-size:13px;color:var(--muted)}
.input, textarea, select{width:100%;padding:8px;border:1px solid #e6eefc;border-radius:8px;font-size:14px}
.row{display:flex;gap:8px}
.img-thumb{width:100%;height:80px;object-fit:cover;border-radius:6px;border:1px solid #eef6ff}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-top:12px}
.card-click{cursor:pointer;border:1px dashed #e6f0ff;padding:8px;border-radius:8px;text-align:center}
.lang-toggle{padding:6px 8px;border-radius:8px;border:1px solid rgba(0,0,0,.06);background:white;cursor:pointer}
.footer{font-size:13px;color:var(--muted);margin-top:16px;text-align:center}
@media(max-width:800px){.flex{flex-direction:column} .controls{flex-wrap:wrap}}
</style>
</head>
<body>
<div class="container" id="app">
  <div class="header">
    <div class="brand">
      <div class="logo">BG</div>
      <div>
        <div class="title" id="siteTitle">Basma Games</div>
        <div class="small" id="siteDesc">Create and play simple educational games</div>
      </div>
    </div>
    <div class="controls">
      <button class="btn ghost" onclick="goBack()">← Back</button>
      <select id="uiLang" class="input" style="width:140px" onchange="setUiLang(this.value)">
        <option value="en">English</option>
        <option value="ar">العربية</option>
      </select>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div><strong id="pageTitle">Match in Pairs — Editor</strong><div class="small" id="pageSub">Design pairs (text or image), save, and play.</div></div>
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="saveGame()">Save Game</button>
        <button class="btn ghost" onclick="downloadGame()">Download HTML</button>
      </div>
    </div>

    <div class="flex" style="margin-top:12px">
      <div class="col">
        <div class="small">Game title</div>
        <input id="gameTitle" class="input" value="New Match Game" />

        <div style="display:flex;gap:8px;margin-top:8px">
          <div style="flex:1">
            <div class="small">Game language</div>
            <select id="gameLang" class="input">
              <option value="en">English</option>
              <option value="ar">العربية</option>
            </select>
          </div>
          <div style="width:140px">
            <div class="small">Add item</div>
            <select id="newKind" class="input"><option value="text">Text</option><option value="image">Image</option></select>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="small">Item content (if text)</div>
          <input id="newContent" class="input" placeholder="e.g. Cat" />

          <div class="small" style="margin-top:8px">Or upload image / pick from library</div>
          <div class="row" style="margin-top:6px">
            <label class="btn ghost" style="display:inline-flex;align-items:center;gap:8px">
              Upload <input id="fileUpload" type="file" accept="image/*" style="display:none" onchange="handleFileUpload(event)" />
            </label>
            <button class="btn ghost" onclick="openImageLibrary()">Image Library</button>
            <button class="btn" onclick="addNewItem()">Add Item</button>
          </div>

          <div class="small" style="margin-top:10px">Pair ID (group items into pairs by same ID)</div>
          <input id="pairId" class="input" placeholder="p1" />

          <div class="small" style="margin-top:12px">Current items</div>
          <div id="itemsList" class="grid"></div>
        </div>
      </div>

      <div style="width:380px">
        <div class="small">Image Library <span id="imgCount"></span></div>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="imgSearch" class="input" placeholder="Search images..." oninput="renderImageLibrary()" />
          <button class="btn ghost" onclick="document.getElementById('manualUrl').style.display='block'">Add URL</button>
        </div>
        <div id="manualUrl" style="display:none;margin-top:8px">
          <input id="imgUrl" class="input" placeholder="https://example.com/image.jpg" />
          <div class="row" style="margin-top:6px">
            <input id="imgName" class="input" placeholder="Optional name" />
            <button class="btn" onclick="addImageByUrl()">Add</button>
          </div>
        </div>

        <div id="imageGrid" class="grid"></div>

        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn ghost" onclick="previewGame()">Preview</button>
          <button class="btn" onclick="playGame()">Play</button>
        </div>
      </div>
    </div>
  </div>

  <div id="playArea" class="card" style="display:none;margin-top:12px"></div>

  <div class="footer">Built for Basma — Images & games are stored in your browser (localStorage). Use Download HTML to create a standalone file.</div>
</div>

<script>
/* Minimal single-file game studio */

const STORAGE_GAMES = 'basma_games_v1';
const STORAGE_IMAGES = 'basma_images_v1';

let state = {
  games: [],
  images: [],
  current: { id: null, title: 'New Match Game', type: 'pairs', language: 'en', items: [] }
};

function loadState(){
  try{ state.games = JSON.parse(localStorage.getItem(STORAGE_GAMES) || '[]'); }catch(e){state.games=[];}
  try{ state.images = JSON.parse(localStorage.getItem(STORAGE_IMAGES) || '[]'); }catch(e){state.images=[];}
  renderUI();
}
function saveState(){ localStorage.setItem(STORAGE_GAMES, JSON.stringify(state.games)); localStorage.setItem(STORAGE_IMAGES, JSON.stringify(state.images)); }

function renderUI(){
  document.getElementById('gameTitle').value = state.current.title || 'New Match Game';
  document.getElementById('gameLang').value = state.current.language || 'en';
  renderItems();
  renderImageLibrary();
  document.getElementById('imgCount').innerText = '('+state.images.length+')';
}

function addNewItem(){
  const kind = document.getElementById('newKind').value;
  const content = document.getElementById('newContent').value.trim();
  const pid = document.getElementById('pairId').value.trim() || 'p'+Math.random().toString(36).slice(2,6);
  let item = { id: 'i'+Math.random().toString(36).slice(2,6), kind: kind, content: '', pairId: pid };
  if(kind==='text'){
    if(!content){ alert('Add text content'); return; }
    item.content = content;
  } else {
    // if user uploaded and last uploaded image stored as tempLastImage
    if(window.tempLastImage){ item.content = window.tempLastImage.data; item.kind='image'; window.tempLastImage = null; }
    else { alert('Pick an image from library or upload first'); return; }
  }
  state.current.items.push(item);
  document.getElementById('newContent').value = '';
  document.getElementById('pairId').value = '';
  renderItems();
  saveState();
}

function renderItems(){
  const wrap = document.getElementById('itemsList');
  wrap.innerHTML = '';
  state.current.items.forEach(it=>{
    const div = document.createElement('div');
    div.className = 'card-click';
    div.innerHTML = it.kind==='image'? '<img src="'+it.content+'" class="img-thumb" />' : '<div style="font-size:18px">'+escapeHtml(it.content)+'</div>';
    const meta = document.createElement('div'); meta.className='small'; meta.style.marginTop='6px'; meta.innerText = 'pair: '+it.pairId;
    const del = document.createElement('button'); del.className='btn ghost'; del.style.marginTop='6px'; del.innerText='Delete'; del.onclick = ()=>{ state.current.items = state.current.items.filter(x=>x.id!==it.id); renderItems(); saveState(); };
    div.appendChild(meta); div.appendChild(del);
    wrap.appendChild(div);
  });
}

function handleFileUpload(e){
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    const data = reader.result;
    const img = { id: 'img'+Math.random().toString(36).slice(2,8), name: f.name, data, createdAt: Date.now() };
    state.images.unshift(img);
    window.tempLastImage = img;
    saveState();
    renderImageLibrary();
    alert('Image uploaded. Now click Add Item to use it in your pair.');
  };
  reader.readAsDataURL(f);
}

function openImageLibrary(){
  // scroll to image grid
  document.getElementById('imgSearch').focus();
  window.scrollTo({top: document.getElementById('imageGrid').offsetTop - 80, behavior:'smooth'});
}

function addImageByUrl(){
  const url = document.getElementById('imgUrl').value.trim();
  if(!url) return alert('Enter image URL');
  const name = document.getElementById('imgName').value.trim() || url.split('/').pop().slice(0,20);
  const img = { id: 'img'+Math.random().toString(36).slice(2,8), name, data: url, createdAt: Date.now() };
  state.images.unshift(img);
  document.getElementById('imgUrl').value=''; document.getElementById('imgName').value='';
  saveState(); renderImageLibrary();
}

function renderImageLibrary(){
  const q = document.getElementById('imgSearch').value.trim().toLowerCase();
  const grid = document.getElementById('imageGrid');
  grid.innerHTML = '';
  state.images.filter(i=> i.name.toLowerCase().includes(q) || i.id.includes(q)).forEach(img=>{
    const el = document.createElement('div'); el.className='card-click';
    el.innerHTML = '<img src="'+img.data+'" class="img-thumb" /><div class="small" style="margin-top:6px">'+escapeHtml(img.name)+'</div>';
    const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.marginTop='6px';
    const choose = document.createElement('button'); choose.className='btn ghost'; choose.innerText='Use'; choose.onclick = ()=>{ window.tempLastImage = img; alert('Image selected. Now click Add Item.'); };
    const del = document.createElement('button'); del.className='btn ghost'; del.style.color='red'; del.innerText='Delete'; del.onclick = ()=>{ if(confirm('Delete image?')){ state.images = state.images.filter(x=>x.id!==img.id); saveState(); renderImageLibrary(); } };
    row.appendChild(choose); row.appendChild(del); el.appendChild(row);
    grid.appendChild(el);
  });
  document.getElementById('imgCount').innerText = '('+state.images.length+')';
}

function previewGame(){
  const area = document.getElementById('playArea');
  area.style.display = 'block';
  area.innerHTML = '<h3>Preview</h3>';
  const title = document.createElement('div'); title.innerText = state.current.title; title.style.fontWeight='700'; title.style.marginBottom='8px';
  area.appendChild(title);
  const wrap = document.createElement('div'); wrap.className='grid'; area.appendChild(wrap);
  state.current.items.forEach(it=>{
    const card = document.createElement('div'); card.className='card-click';
    card.style.height='90px'; card.style.display='flex'; card.style.alignItems='center'; card.style.justifyContent='center';
    if(it.kind==='image') card.innerHTML = '<img src="'+it.content+'" class="img-thumb" />'; else card.innerText = it.content;
    wrap.appendChild(card);
  });
  area.scrollIntoView({behavior:'smooth'});
}

function playGame(){
  if(state.current.items.length % 2 !==0){ if(!confirm('Items are not complete pairs. Continue?')) return; }
  const area = document.getElementById('playArea');
  area.style.display = 'block';
  area.innerHTML = '<h3>Play — Match in Pairs</h3>';
  const title = document.createElement('div'); title.innerText = state.current.title; title.style.fontWeight='700'; title.style.marginBottom='8px';
  area.appendChild(title);
  const cards = state.current.items.map((it,i)=> ({...it, _idx:i}));
  shuffle(cards);
  const grid = document.createElement('div'); grid.className='grid'; area.appendChild(grid);
  let first=null, second=null;
  cards.forEach((c,idx)=>{
    const el = document.createElement('div'); el.className='card-click'; el.style.height='100px'; el.style.display='flex'; el.style.alignItems='center'; el.style.justifyContent='center';
    el.innerHTML = '<div style="font-size:22px">?</div>';
    el.onclick = ()=>{
      if(el.dataset.matched) return;
      if(c.kind==='image'){ el.innerHTML = '<img src="'+c.content+'" style="max-width:120px;max-height:80px"/>'; } else { el.innerHTML = '<div style="font-size:18px">'+escapeHtml(c.content)+'</div>'; }
      if(!first){ first={c,el,idx}; } else if(!second && idx!==first.idx){ second={c,el,idx};
        if(first.c.pairId === second.c.pairId){ first.el.style.visibility='hidden'; second.el.style.visibility='hidden'; first.el.dataset.matched=true; second.el.dataset.matched=true; first=null; second=null;
          if(Array.from(grid.children).every(ch=>ch.style.visibility==='hidden')) setTimeout(()=>alert(state.current.language==='ar'?'مبروك!':'Well done!'),200);
        } else {
          setTimeout(()=>{ first.el.innerHTML = '<div style="font-size:22px">?</div>'; second.el.innerHTML = '<div style="font-size:22px">?</div>'; first=null; second=null; },700);
        }
      }
    };
    grid.appendChild(el);
  });
  area.scrollIntoView({behavior:'smooth'});
}

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

function saveGame(){
  state.current.title = document.getElementById('gameTitle').value.trim() || 'Untitled';
  state.current.language = document.getElementById('gameLang').value;
  // store a copy
  const copy = JSON.parse(JSON.stringify(state.current));
  if(!copy.id) copy.id = 'g'+Math.random().toString(36).slice(2,8);
  const exists = state.games.findIndex(g=>g.id===copy.id);
  if(exists>=0) state.games[exists] = copy; else state.games.unshift(copy);
  saveState();
  alert('Saved locally in your browser. To share, use Download HTML.');
}

function downloadGame(){
  const html = generateStandalone(state.current);
  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = (state.current.title || 'game') + '.html'; a.click(); URL.revokeObjectURL(url);
}

function generateStandalone(game){
  const payload = JSON.stringify(game).replace(/</g,'\\u003c');
  return `<!doctype html><html lang="${game.language||'en'}"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>${escapeHtml(game.title||'Game')}</title><style>body{font-family:Arial,Helvetica,sans-serif;padding:12px}.card{border-radius:8px;padding:10px;border:1px solid #ddd;margin:8px;display:inline-block}.grid{display:flex;flex-wrap:wrap;gap:8px}</style></head><body><h1>${escapeHtml(game.title||'Game')}</h1><div id='root'></div><script>const GAME=${payload};(function(){const root=document.getElementById('root');if(GAME.type==='pairs'){const cards=GAME.items.map((it,i)=>({...it,_i:i}));for(let i=cards.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[cards[i],cards[j]]=[cards[j],cards[i]]}const container=document.createElement('div');container.className='grid';let first=null,second=null;cards.forEach((c,idx)=>{const el=document.createElement('div');el.className='card';el.style.width='140px';el.style.height='90px';el.style.display='flex';el.style.alignItems='center';el.style.justifyContent='center';el.textContent='?';el.onclick=function(){if(el.dataset.matched)return;if(c.kind==='image'){el.innerHTML='';const img=document.createElement('img');img.src=c.content;img.style.maxWidth='120px';img.style.maxHeight='80px';el.appendChild(img);}else el.textContent=c.content;if(!first)first={c,el};else if(!second && el!==first.el){second={c,el};if(first.c.pairId===second.c.pairId){first.el.style.visibility='hidden';second.el.style.visibility='hidden';first.el.dataset.matched=true;second.el.dataset.matched=true;first=null;second=null;if(Array.from(container.children).every(ch=>ch.style.visibility==='hidden'))setTimeout(()=>alert('Well done!'),200);}else setTimeout(()=>{first.el.textContent='?';second.el.textContent='?';first.el.innerHTML='';second.el.innerHTML='';first=null;second=null;},700);}};container.appendChild(el)});root.appendChild(container);}else{root.textContent='No player for this type.'}})();</script></body></html>`;
}

function setUiLang(v){
  document.documentElement.lang = v;
  // small UI translations (we keep minimal)
  if(v==='ar'){ document.getElementById('siteTitle').innerText='ألعاب بسمة'; document.getElementById('pageTitle').innerText='محرر مطابقة الأزواج'; document.getElementById('pageSub').innerText='صممي الأزواج (نص/صورة) واحفظيها.'; }
  else{ document.getElementById('siteTitle').innerText='Basma Games'; document.getElementById('pageTitle').innerText='Match in Pairs — Editor'; document.getElementById('pageSub').innerText='Design pairs (text or image), save, and play.'; }
}

function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

function goBack(){ history.back(); }

// Initialize
loadState();
setUiLang('en');

</script>
</body>
</html>
